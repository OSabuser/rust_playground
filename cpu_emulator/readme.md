# Реализация подмножества системы CHIP-8

## CPU RIA/1: сумматор

**Операция(op)** - процедура, изначально поддерживаемая процессором;  
**Регистры** - контейнеры для данных, к которым CPU имеет непосредственный доступ.  

    Для работы большинства операций операнды должны быть помещены в регистры. *У CHIP-8 регистры имеют формат u8.*

**Код операции** - число, отображаемое на операцию. На платформе CHIP-8 коды операций включают в себя регистры операций и операндов.  

Для выполнения суммирования:

1. Инициализация CPU;
2. Загрузить значения ***u8*** в регистры;
3. Загрузить код операции в переменную текущей операции;
4. Выполнить операцию.

Каждый код операции состоит из двух байтов: старшего и младшего.  
Каждый байт состоит из полубайтов (тетрад): старшего и младшего.  
![Opcode contents](image.png)  
![Opcode decoding](image-1.png)  

## CPU RIA/2: мультипликатор

Может выполнять последовательно несколько инструкций.  
Состоит из ОЗУ, основго цикла и переменной, указывающей, какую инструкцию выполнять следующей.  

## CPU RIA/3: блок вызова

Для реализации функций необходимо добавить дополнительные ***opcode***:  

1. Код операции вызова *CALL* (0x2nnn, nnn - адрес памяти), устанавливающий для *position_on_memory* значение *nnn*, являющееся адресом функции;
2. Код операции вызова возращения *RETURN* (0x00EE), устанавливающий для *position_on_memory* значение, соответствующее адресу предыдущего кода операции *CALL*.  

CPU нужна *специальная выделенная память для хранения адресов* - **стек**. Каждый код операции **CALL** добавляет адрес в стек путём увеличения значения указателя стека и записи значения *nnn* в текущую позицию в стеке. Каждый код операции **RETURN** удаляет верхний адрес, уменьшая значение стека.  

Функция - последовательность байтов, содержащая код, который выполняется CPU:  

                add_twice:
                    0x8014
                    0x8014
                    0x00EE

                let add_twice: [u8;6] = [
                    0x80, 0x14,
                    0x80, 0x14,
                    0x00, 0xEE
                ]

Загрузка функции в ОЗУ (например, по адресу ***0x100***):  

                let mut memory: [u8;4096] = [0;4096];
                let mem = &mut memory;

С помощью слайса:
`mem[0x100..0x106].copy_from_slice(&add_twice);`

В лоб:
`mem[0x100] = 0x80; mem[0x101] = 0x14;`  



